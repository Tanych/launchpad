{% extends "base.html" %}
{% load launchpad_extras %}
{% load url from future %}

{% block title %}{% if bib.CJK_INFO.TITLE %}{{ bib.CJK_INFO.TITLE }}{% else %}{% if bib.TITLE|length <= 254 %}{{ bib.TITLE }}{% else %}{{ bib.TITLE|truncatewords:-1 }}{% endif %}{% endif %}{% endblock title %}

{% block link_extra %}
{% with url_name="item_json" %}
<link rel='alternate' type='application/json' href='{% url url_name bibid %}' />
{% endwith %}
{% endblock link_extra %}

{% block content %}

<table border='0'>
    <tr>
        <td width='70%' valign='top'>
<h1 class="title">
{% if bib.CJK_INFO.TITLE %}
    {{ bib.CJK_INFO.TITLE }} <br />
{% endif %}
{% if bib.TITLE|length <= 254 %}
    {{ bib.TITLE }}
{% else %}
    {{ bib.TITLE|truncatewords:-1 }}
{% endif %}
</h1>

{% if bib.AUTHOR or bib.CJK_INFO.AUTHOR or bib.AUTHORS %}
<span class="author">
{% if bib.CJK_INFO.AUTHOR %}
    {{ bib.CJK_INFO.AUTHOR }} <br />
{% endif %}
{% if bib.AUTHORS %}
    {{ bib.AUTHORS|join:"; " }}
    <br />
{% endif %}
</span>
{% endif %}

{% if bib.EDITION %}
<span class="edition">{{ bib.EDITION }}.</span>
{% endif %}
<span class="imprint">
{% if bib.CJK_INFO.IMPRINT %}
    {{ bib.CJK_INFO.IMPRINT }} <br />
{% endif %}
    {{ bib.IMPRINT }}</span>{% if bib.IMPRINT|slice:"-1:" == '.' or bib_IMPRINT|slice:"-2:" == '. ' %}{% else %}.{% endif %}

</span>
{% if bib.LANGUAGE_DISPLAY %}
In <span class="language">{{ bib.LANGUAGE_DISPLAY }}.</span>
{% endif %}
<br />

{% if bib.DISPLAY_ISBN_LIST %}
<span class="isbn-label">ISBN </span>
<span class="isbn">
    {{ bib.DISPLAY_ISBN_LIST|join:", " }}
</span><br/>
{% endif %}
{% if bib.DISPLAY_ISSN_LIST %}
<span class="isbn-label">ISSN </span>
<span class="issn">
    {{ bib.DISPLAY_ISSN_LIST|join:", " }}
</span><br/>
{% endif %}

<p>

<span class="catlink">View detailed description of this title in the <a href='http://catalog.wrlc.org/cgi-bin/Pwebrecon.cgi?DB=local&BBID={{ bib.BIB_ID }}' target='newwin'>Aladin Catalog</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/></span>
</p>

        </td>
        <td width='30%' style='padding-left:2em;'>
{% if bib.ISBN|clean_isbn %}
    <img src='http://covers.openlibrary.org/b/isbn/{{ bib.ISBN|clean_isbn }}-M.jpg' title='cover image from Open Library' alt='cover image'/>
{% else %}
    &nbsp;
{% endif %}
        </td>
    </tr>
</table>


{% if holdings %}
    {% regroup holdings by LIBRARY_FULL_NAME as library_list %}
<table WIDTH='100%'> 
<!--
    <thead>
        <tr>
            <th width='40%'>Location</th>
            <th width='30%'>Call Number</th>
            <th width='15%'>Status</th>
            <th width='15%'>Consortium Loan</th>
        </tr>
    </thead>-->
    <tbody>		
    {% for library in library_list %}
        <tr><th colspan='4' class='library-group-header'>
            {{ library.grouper }}
        </th></tr>
        <tr>
            <th width='40%'>Location</th>
            <th width='30%'>Call Number / Volume</th>
            <th width='15%'>Status</th>
            <th width='15%'>Consortium Loan</th>
        </tr>
        {% for holding in library.list %}
            {% if holding.ITEMS %}
                {% for item in holding.ITEMS %}
            <tr>
                <td>
                    {% if item.TEMPLOCATION %}
                    <span class='temp-loc-label'>Temporarily held at:</span><br />
                        {{ item.TEMPLOCATION }}
                    {% else %}
                        {{ item.TRIMMED_LOCATION_DISPLAY_NAME }}
                    {% endif %}
                    {% if holding.MFHD_DATA and holding.MFHD_DATA.marc866list and forloop|length_is:"1" %}
                        {% for line in holding.MFHD_DATA.marc866list %}
                            <br />
                            <span class="library-has">{{ line }}</span>
                        {% endfor %}
                    {% endif %}
                    {% if holding.MFHD_DATA.marc852 and forloop.first %}
                    <br /><span class="note-label">Note: </span>
                    <span class="note">{{ holding.MFHD_DATA.marc852 }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.DISPLAY_CALL_NO %} {{ item.DISPLAY_CALL_NO }} {% endif %}
                    {% if item.ITEM_ENUM %} {{ item.ITEM_ENUM }} {% endif %}
                </td>
                <td>
                    {% if holding.MFHD_DATA and holding.MFHD_DATA.marc856list %}
                        {% for link in holding.MFHD_DATA.marc856list %}
                            {% if link.3 %}
                    <span class="link-volumes">[{{ link.3 }}]</span>
                            {% endif %}
                            {% if holding.LIBRARY_NAME != 'GW' and holding.LIBRARY_FULL_NAME != 'WRLC' %}
                    <img style = 'height:1em;' src = '{{ STATIC_URL }}img/lock.png'></img>
                    <a href="{{link.u}}" target="clswindow">Full text online {{holding.LIBRARY_NAME}} only</a>
                    <img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                            {%else%}
                    <a href="{{link.u}}" target="clswindow">Full text online </a>
                    <img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                            {%endif%}
                            {% if not forloop.last %}<hr />{% endif %}
                        {% endfor %}
                    {% else %}
                        {%if item.ITEM_STATUS_DESC = 'Not Charged'%}
                            <span style='color: green'>Available</span>
                        {%else%}
                            {% if item.AVAILABILITY.TEMPLOCATION == 'WRLC Center'%}
                            <span class='off-site'>Off-site </span><br /><span class='off-site-explanation'>(Available by request)</span>
                            {% else %}
                                {{ item.ITEM_STATUS_DESC }}
                            {% endif %}
                        {%endif%}
                    {% endif %}
                </td>
                <td>
                    {% if item.ELIGIBLE %}
                    <a href='https://www.aladin.wrlc.org/Z-WEB/CLSReqForm?srcid=voyager:WRLC&bibid={{ holding.BIB_ID }}' target='clswindow'>Request</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                    {% endif %}
                </td>
            </tr>
                {% endfor %}
            <!--  If no item data use old template -->
            {% else %}
                <tr>
                    <td>{% if holding.AVAILABILITY.TEMPLOCATION %}
                            <span class='temp-loc-label'>Temporarily held at:</span><br />
                            {{ holding.AVAILABILITY.TEMPLOCATION }}
                        {% else %}
                            {{ holding.TRIMMED_LOCATION_DISPLAY_NAME }}
                        {% endif %}
                        {% if holding.LIBRARY_HAS %}
                            {% for line in holding.LIBRARY_HAS %}
                                <br />
                                <span class="library-has">{{ line }}</span>
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td>
                        {% if holding.DISPLAY_CALL_NO %}
                            {{ holding.DISPLAY_CALL_NO }}
                        {% endif %}
                    </td>
                    <td>
                        {% if holding.ELECTRONIC_DATA and holding.ELECTRONIC_DATA.LINK856U %}
                            {% if holding.ELECTRONIC_DATA.LINK8563 %}
                                <span class="link-volumes">[{{ holding.ELECTRONIC_DATA.LINK8563 }}]</span>
                            {% endif %}
                            {% if holding.LIBRARY_NAME != 'GW' and holding.LIBRARY_FULL_NAME != 'WRLC' %}
                                <img style = 'height:1em;' src = '{{ STATIC_URL }}img/lock.png'> </img><a href="{{holding.ELECTRONIC_DATA.LINK856U}}" target="clswindow">Full text online {{holding.LIBRARY_NAME}} only</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                            {%else%}
                                <a href="{{holding.ELECTRONIC_DATA.LINK856U}}" target="clswindow">Full text online </a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                            {%endif%}
                        {% else %}
                            {%if holding.AVAILABILITY.ITEM_STATUS_DESC = 'Not Charged'%}
                                <span style='color: green'>Available</span>
                            {%else%}
                                {% if holding.AVAILABILITY.TEMPLOCATION == 'WRLC Center'%}
                                    <span class='off-site'>Off-site </span><br /><span class='off-site-explanation'>(Available by request)</span>
                                {% else %}
                                    {{ holding.AVAILABILITY.ITEM_STATUS_DESC }}
                                {% endif %}
                            {%endif%}
                        {% endif %}
                    </td>
                    <td>
                        {% if holding.ELIGIBLE %}
                            <a href='https://www.aladin.wrlc.org/Z-WEB/CLSReqForm?srcid=voyager:WRLC&bibid={{ holding.BIB_ID }}' target='clswindow'>Request</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                        {% endif %}
                    </td>
                </tr>
            {% endif %}
        {% endfor %}
    {% endfor %}
    </tbody>
</table> 
{% else %}
<p>
No copies found in WRLC.  ADD ILL LINK.
</p>
{% endif %}

{% if debug %}
<h3>Debugging info</h3>

<p>
{% with json_url="item_json" %}
View JSON: <a href='{% url json_url bibid %}'>{% url json_url bibid %}</a>
{% endwith %}
&nbsp;

{% if bib.ISBN|clean_isbn %}
{% with isbn_url="isbn" %}
ISBN: <a href='{% url isbn_url bib.ISBN|clean_isbn %}'>{% url isbn_url bib.ISBN|clean_isbn %}</a>
&nbsp;
(<a href='http://findit.library.gwu.edu/go?isbn={{ bib.ISBN|clean_isbn }}'>findit</a>)
&nbsp;
{% endwith %}
{% endif %}
{% if bib.ISSN|clean_issn %}
{% with issn_url="issn" %}
ISSN: <a href='{% url issn_url bib.ISSN|clean_issn %}'>{% url issn_url bib.ISSN|clean_issn %}</a>
&nbsp;
(<a href='http://findit.library.gwu.edu/go?issn={{ bib.ISSN|clean_issn }}'>findit</a>)
&nbsp;
{% endwith %}
{% endif %}
{% if bib.NETWORK_NUMBER|clean_oclc %}
{% with oclc_url="oclc" %}
OCLC: <a href='{% url oclc_url bib.NETWORK_NUMBER|clean_oclc %}'>{% url oclc_url bib.NETWORK_NUMBER|clean_oclc %}</a>
&nbsp;
{% endwith %}
{% endif %}
</p>


{% endif %}

{% endblock content %}

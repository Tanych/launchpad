{% extends "base.html" %}
{% load launchpad_extras %}
{% load url from future %}


{% block title %}
    {% if bib.CJK_INFO.TITLE %}
        {{ bib.CJK_INFO.TITLE }}
    {% else %}
        {% if bib.TITLE|length <= 254 %}
            {{ bib.TITLE }}
        {% else %}
            {{ bib.TITLE|truncatewords:-1 }}
        {% endif %}
    {% endif %}
{% endblock title %}

{% block link_extra %}
{% if bibid %}
    <link rel='canonical' href='{% url "item" bibid %}' />
    <link rel='alternate' type='application/json' href='{% url "item_json" bibid %}' />
{% endif %}
{% endblock link_extra %}

{% block javascript_extra %}
<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js'></script>
<script type='text/javascript'>
function toggle_visibility(tbid,lnkid)
{
 if(document.all){document.getElementById(tbid).style.display = document.getElementById(tbid).style.display == "block" ? "none" : "block";}
  else{document.getElementById(tbid).style.display = document.getElementById(tbid).style.display == "table" ? "none" : "table";}
  document.getElementById(lnkid).value = document.getElementById(lnkid).value == "[-] Less Items" ? "[+] More Items" : "[-] Less Items";

};

function showmore(id)
	{
		var objt = document.getElementById("toggle-"+id);
		var objb = document.getElementById("brief-"+id);
		var objf = document.getElementById("full-"+id);
		if(objf.style.display == 'block') 
                {
			objf.style.display='none';
			objb.style.display='block';
			objt.innerHTML="<a href=javascript:showmore('1');>[+] More Text</a>";

		}
                else 
                {
			objf.style.display='block';
			objb.style.display='none';
			objt.innerHTML="<a href=javascript:showmore('1');>[-] Less Text</a>";
		}		

	};
</script>

<script type='text/javascript'>
// hide missing cover images' surrounding <div>
$(document).ready(function() {
    $('#cover-image').load(function() {
        if ($('#cover-image').width() == 1) {
            $('#cover').toggle(200);
        };
        //hide the all of the items with class item_body
	$(".item_body").hide();
	//toggle the componenet with class item_body
	$(".item_head").click(function(){
		$(this).next(".item_body").slideToggle(250);
        });

    });
// show txt/email button
var newwindow;
function sms(url) {
    newwindow = window.open(url, 'name', 'height=590,width=400,toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0');
    if (window.focus) {
        newwindow.focus();
    };
};


</script>
{% endblock javascript_extra %}

{% block content %}

<div itemscope itemtype="{{bib.MICRODATA_TYPE}}">

<table border='0' style='width:100%;'>
    <tr>
        <td>
            {% if bib.ISBN|clean_isbn %}
            <div id='cover'>
                <img itemprop="image" id='cover-image' src='http://covers.openlibrary.org/b/isbn/{{ bib.ISBN|clean_isbn }}-M.jpg' title='cover image from Open Library' alt='cover image'/>
            </div>
            {% endif %}
            <div id='description'>
                <span id="titleinfo">
                <h1 class="title" >
                {% if bib.CJK_INFO.TITLE %}
                    <span itemprop="name">{{ bib.CJK_INFO.TITLE }}</span> <br />
                {% endif %}
                {%if bib.TITLE_ALL|length <= title_chars or TITLE_ALL|length > title_chars and bib.BRIEF_LENGTH < title_leftover_chars%}
                    <span itemprop="name">{{bib.TITLE_ALL}}</span><br/>
                {%endif%}
                {%if bib.TITLE_ALL|length > title_chars and bib.BRIEF_LENGTH and  bib.BRIEF_LENGTH > title_leftover_chars%}
                    <div id="brief-1" style="display:block">
                        {{bib.TITLE_BRIEF}}
                    </div>
                    <div id="full-1" style="display:none">
                        <span itemprop="name">{{bib.TITLE_ALL}}</span>
                    </div>
                    <div id="toggle-1"> 
                        <a href='javascript:showmore("1")';>[+] More Text</a>
                    </div>
                {% endif %}
                </h1>
                </span>
                {% if bib.openurl.query_string %}
                    {% include "openurl.html" %}
                {% endif %}
                {% if bib.AUTHOR or bib.CJK_INFO.AUTHOR or bib.AUTHORS %}
                    <span class="author">
                    {% if bib.CJK_INFO.AUTHOR %}
                        <span itemprop="author">{{ bib.CJK_INFO.AUTHOR }}</span> <br />
                    {% endif %}
                    {% if bib.AUTHORS %}
                        {% for contributor in bib.AUTHORS %}
                            {% if forloop.first %}
                                <span itemprop="author">{{contributor}}</span>
                            {% else %}
                                <span itemprop="contributor">{{contributor}}</span>
                            {% endif %}
                            {% if not forloop.last %}; {% endif %}
                        {% endfor %}
                    {% else %}
                        {% if bib.AUTHOR %}
                            <span itemprop="author">{{ bib.AUTHOR }}</span>
                        {% endif %}
                    {% endif %}
                    </span><br />
                {% endif %}

                {% if bib.EDITION %}
                    <span class="edition">{{ bib.EDITION }}.</span>
                {% endif %}
                <span class="imprint">
                    {% if bib.CJK_INFO.IMPRINT %}
                        <span itemprop="publisher">
                        {{ bib.CJK_INFO.IMPRINT }}
                        </span><br />
                    {% endif %}
                    {% if bib.IMPRINT %}
                        <span itemprop="publisher">
                        {{ bib.IMPRINT }}
                        </span>
                        {% if bib.IMPRINT|slice:"-1:" == '.' or bib_IMPRINT|slice:"-2:" == '. ' %}
                        {% else %}.
                        {% endif %}
                    {% endif %}
                </span>

                {% if bib.LANGUAGE_DISPLAY %}
                    In <span itemprop="inLanguage" class="language">{{ bib.LANGUAGE_DISPLAY }}.</span>
                {% endif %}
                <br />

                {% if bib.DISPLAY_ISBN_LIST %}
                    <span class="isbn-label">ISBN </span>
                    <span class="isbn">
                        {% for isbn in bib.DISPLAY_ISBN_LIST %}
                            <span itemprop="isbn">{{ isbn }}</span>
                            {% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </span><br />
                {% endif %}
                {% if bib.DISPLAY_ISSN_LIST%}
                    <span class="isbn-label">ISSN </span>
                    <span class="issn">{{ bib.DISPLAY_ISSN_LIST|join:", " }}</span><br/>
                {% endif %}
                <p>
                    <span class="catlink" >
                    {% if bib.BIB_ID %}
                        View detailed description of this title in the <a href='http://catalog.wrlc.org/cgi-bin/Pwebrecon.cgi?DB=local&BBID={{ bib.BIB_ID }}' target='newwin'>Aladin Catalog</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                    {% endif %}
                    </span>
                    </p>
                    {%if bib.ILLIAD_LINK and bib.BIB_FORMAT != 'as'%}
                     <p>
                     <span class = "catlink"> 
                      Request this title through  <a href= {{bib.ILLIAD_LINK}} target='newwin'> Interlibrary Loan </a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/> 
                    </span></p>
                   {%endif%}
                   
            </div>
        </td>
    </tr>
</table>

</div>


{% if holdings %}
    {% regroup holdings by LIBRARY_FULL_NAME as library_list %}
<table WIDTH='100%'> 
    <thead>
        <tr>
            <th width='40%'>Location</th>
            <th width='25%'>Call Number</th>
            <th width='20%'>Status</th>
            <th width='15%'>Consortium Loan</th>
        </tr>
    </thead>
    <tbody>		
    {% for library in library_list %}
        {% if library.grouper %}
        <tr>
            <td class='library-group-header'>
            {{ library.grouper }}
            </td>
        </tr>
        {% endif %}
        {% for holding in library.list %}
            {% if holding.ITEMS %}
                {% for item in holding.ITEMS %}
                    {%if holding.MFHD_DATA.marc866list or holding.MFHD_DATA.marc852%}
                        {%if forloop.first and not holding.MFHD_DATA.marc856list%}
                        <tr>
                        <td>
                        <div class="itemrow">
                            {% if item.TEMPLOCATION %}
                                {{ item.TEMPLOCATION|noscream }}
                                <br/>
                            {% else %}
                                {{ item.TRIMMED_LOCATION_DISPLAY_NAME|noscream }}
                                <br />
                            {%endif%}
                            {% if holding.MFHD_DATA.marc866list%}
                                {% for line in holding.MFHD_DATA.marc866list %}
                                    <span class="library-has">{{ line }}</span>
                                    <br />
                                {% endfor %}
                            {% endif %}
                            {% if holding.MFHD_DATA.marc852 %}
                                <span class="note-label">{{ holding.MFHD_DATA.marc852 }}</span>
                                <br />
                            {% endif %}
                        </tr>
                        </td>
                        </div>
                        {%endif%}
                    {%endif%}
                    <tr>
                    {%if holding.ITEMS|length > max_items and forloop.counter >= max_items%}
                    <td width='51%'>
                    {%else%}    
                    <td width='40%'>
                    {%endif%}
                    <div class="itemrow">
                            {% if item.TEMPLOCATION %}
                                {{ item.TEMPLOCATION|noscream }}
                                <br/>
                                {%if holding.ITEMS|length > max_items and forloop.counter == max_items%}
                                    <input id="{{holding.BIB_ID}}1" type="button" value="[+] More Items" style="border:none;background:none;color:blue;" onclick="toggle_visibility('{{holding.BIB_ID}}','{{holding.BIB_ID}}1');">
                                {%endif%}
                            {% else %}
                                {{ item.TRIMMED_LOCATION_DISPLAY_NAME|noscream }}
                                <br />
                                {%if holding.ITEMS|length > max_items and forloop.counter == max_items%}
                                    <input id="{{holding.BIB_ID}}1" type="button" value="[+] More Items" style="border:none;background:none;color:blue;" onclick="toggle_visibility('{{holding.BIB_ID}}','{{holding.BIB_ID}}1');"> 
                                {%endif%}
                            {% endif %}
                        </div>
                        </td>
                        {%if holding.ITEMS|length > max_items and forloop.counter >= max_items%}
                        <td width='23%'>
                        {%else%}
                        <td width='25%'>
                        {%endif%}
                           {% if item.DISPLAY_CALL_NO %} {{ item.DISPLAY_CALL_NO }} {% endif %}
                           {% if item.ITEM_ENUM %} {{ item.ITEM_ENUM }} {% endif %}
                       </td>
                       {%if holding.ITEMS|length > max_items and forloop.counter >= max_items%}
                       <td width='17%'>
                       {%else%}
                       <td width='20%'>
                       {%endif%}
                           {% if holding.MFHD_DATA and holding.MFHD_DATA.marc856list %}
                               {% for link in holding.MFHD_DATA.marc856list|remove_empty_links %}
                                   {% if link.3 %}
                                       <span class="link-volumes">[{{ link.3 }}]</span>
                                   {% endif %}
                                   {% if holding.LIBRARY_NAME != 'GW' and holding.LIBRARY_FULL_NAME != 'WRLC' %}
                                       <a href="{{link.u}}" target="clswindow">Full text online</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                                       <br />
                                       <img style = 'height:1em;' src = '{{ STATIC_URL }}img/lock.png'></img>
                                       {{holding.LIBRARY_NAME}} only
                                   {% else %}
                                       {%if item.DISPLAY_CALL_NO in audio_tags%}
                                           <button onclick="window.open('{{link.u}}')" > Listen online </button>
                                       {%endif%}
                                       {%if item.DISPLAY_CALL_NO in video_tags%}
                                           <button onclick="window.open('{{link.u}}')" > Watch online </button>
                                       {%endif%}
                                       {%if item.DISPLAY_CALL_NO not in audio_tags and item.DISPLAY_CALL_NO not in video_tags%}
                                           <button onclick="window.open('{{link.u}}')" title={{link.u}}> Full text online </button>
                                       {%endif%}
                                   {% endif %}
                                   {% if not forloop.last %}<hr />{% endif %}
                               {% endfor %}
                           {% else %}
                               {%if item.ITEM_STATUS_DESC == 'Not Charged' %}
                                   <span style='color: green'>Available</span>
                                   <a href='javascript:sms("http://catalog.wrlc.org/aquascrape/index.php?{% if item.DISPLAY_CALL_NO %}call={{ item.DISPLAY_CALL_NO|urlencode }}{% endif %}&amp;{% if item.TRIMMED_LOCATION_DISPLAY_NAME %}loc={{ item.TRIMMED_LOCATION_DISPLAY_NAME|noscream|urlencode }}{% endif %}&amp;title={{ bib.TITLE|truncatechars:80|urlencode }}");'><img border='0' src='{{ STATIC_URL }}img/txt.png' alt='text/email this to me' /></a>
                               {%else%}
                                   {% if item.TEMPLOCATION == 'WRLC Center'%}
                                       <span class='off-site'>Off-site </span>
                                       <br />
                                   {% else %}
                                       {{ item.ITEM_STATUS_DESC }}
                                   {% endif %}
                               {%endif%}
                           {%endif%}
                       </td>
                       {%if holding.ITEMS|length > max_items and forloop.counter >= max_items%}
                       <td width= '9%'>
                       {%else%}
                       <td width='15%'>
                       {%endif%}
                           {% if item.ELIGIBLE %}
                               <a href='https://www.aladin.wrlc.org/Z-WEB/CLSReqForm?srcid=voyager:WRLC&bibid={{ holding.BIB_ID }}' target='clswindow'>Request</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                           {% endif %}
                       </td>
                  </tr>
                           {%if holding.ITEMS|length > max_items and forloop.counter == max_items%}
                               <td colspan="4">
                               <table width="100%" id="{{holding.BIB_ID}}" style="display:none;">
                           {%endif%}
                           {%if holding.ITEMS|length > max_items and forloop.last%}
                               </table>
                               </td>
                           {%endif%}
                       {% endfor %}
            <!--  If no item data use old template -->
            {% elif "Click" not in holding.TRIMMED_LOCATION_DISPLAY_NAME %}
                <tr>
                    <td>
                        <div class="itemrow">
                        {% if holding.AVAILABILITY.TEMPLOCATION %}
                            {{ holding.AVAILABILITY.TEMPLOCATION|noscream }}
                            <br />
                            <span class='temp-loc-label'>Temporarily held</span>
                        {% else %}
                            {{ holding.TRIMMED_LOCATION_DISPLAY_NAME|noscream }}
                        {% endif %}
                        {% if holding.LIBRARY_HAS %}
                            {% for line in holding.LIBRARY_HAS %}
                                <br />
                                <span class="library-has">{{ line }}</span>
                            {% endfor %}
                        {% endif %}
                        {%if holding.ELECTRONIC_DATA.LINK852Z%}
                            <br />
                            <span class= "note-label"> {{holding.ELECTRONIC_DATA.LINK852Z}} </span>
                        {%endif%}
                
                        </div>
                    </td>
                    <td>
                        {% if holding.DISPLAY_CALL_NO %}
                            {{ holding.DISPLAY_CALL_NO|noscream }}
                        {% endif %}
                    </td>
                    <td>
                        {% if holding.ELECTRONIC_DATA and holding.ELECTRONIC_DATA.LINK856U %}
                            {% if holding.ELECTRONIC_DATA.LINK8563 %}
                                <span class="link-volumes">[{{ holding.ELECTRONIC_DATA.LINK8563 }}]</span>
                            {% endif %}
                            {% if holding.LIBRARY_NAME != 'GW' and holding.LIBRARY_FULL_NAME != 'WRLC' %}
                                <a href="{{holding.ELECTRONIC_DATA.LINK856U}}" target="clswindow">Full text online</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                                <br />
                                <img style = 'height:1em;' src = '{{ STATIC_URL }}img/lock.png'> </img>
                                {{holding.LIBRARY_NAME}} only
                            {% else %}
                                {%if holding.DISPLAY_CALL_NO in audio_tags%}
                                    <button onclick="window.open('{{holding.ELECTRONIC_DATA.LINK856U}}')" > Listen online </button>
                                {%endif%}
                                {%if holding.DISPLAY_CALL_NO in video_tags%}
                                    <button onclick="window.open('{{holding.ELECTRONIC_DATA.LINK856U}}')" > Watch online </button>
                                {%endif%}
                                {%if holding.DISPLAY_CALL_NO not in audio_tags and holding.DISPLAY_CALL_NO not in video_tags%}
                                    <button onclick="window.open('{{holding.ELECTRONIC_DATA.LINK856U}}')" title={{holding.ELECTRONIC_DATA.LINK856U}}> Full text online </button>
                                {%endif%}
                            {% endif %}
                        {% elif holding.MFHD_DATA and holding.MFHD_DATA.marc856list %}
			    {% for link in holding.MFHD_DATA.marc856list %}
				{% if link.3%}
			            <span class="link-volumes">[{{ link.3 }}]</span>
				{% endif %}
				{% if holding.LIBRARY_NAME != 'GW' and holding.LIBRARY_FULL_NAME != 'WRLC' %}
			            <a href="{{link.u}}" target="clswindow">Full text online</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
			            <br />
			            <img style = 'height:1em;' src = '{{ STATIC_URL }}img/lock.png'></img>
			            {{holding.LIBRARY_NAME}} only
                                {% else %}
                                    {%if holding.DISPLAY_CALL_NO in audio_tags%}
                                        <button onclick="window.open('{{link.u}}')" > Listen online </button>
                                    {%endif%}
                                    {%if holding.DISPLAY_CALL_NO in video_tags%}
                                        <button onclick="window.open('{{link.u}}')" > Watch online </button>
                                    {%endif%}
                                    {%if holding.DISPLAY_CALL_NO not in audio_tags and holding.DISPLAY_CALL_NO not in video_tags %}
                                        <button onclick="window.open('{{link.u}}')" title={{link.u}}> Full text online </button>
                                    {%endif%}
                                {% endif %}
                            {% endfor %}
                        {% elif not holding.ITEMS and holding.LOCATION_DISPLAY_NAME == 'WRLC Center' %}
                            <span class='off-site'>Off-site </span>
                        {% elif holding.AVAILABILITY.ITEM_STATUS_DESC == 'Not Charged' %}
                            <span style='color: green'>Available</span>
                            <a href='javascript:sms("http://catalog.wrlc.org/aquascrape/index.php?{% if holding.DISPLAY_CALL_NO %}call={{ holding.DISPLAY_CALL_NO|urlencode }}{% endif %}&amp;{% if holding.TRIMMED_LOCATION_DISPLAY_NAME %}loc={{ holding.TRIMMED_LOCATION_DISPLAY_NAME|noscream|urlencode }}{% endif %}&amp;title={{ bib.TITLE|truncatechars:80|urlencode }}");'><img border='0' src='{{ STATIC_URL }}img/txt.png' alt='text/email this to me' /></a>

                        {% elif holding.AVAILABILITY.TEMPLOCATION == 'WRLC Center'%}
                            <span class='off-site'>Off-site </span>
                        {% else %}
                            {{ holding.AVAILABILITY.ITEM_STATUS_DESC }}
                        {% endif %}
                    </td>
                    <td>
                        {% if holding.ELIGIBLE %}
                            <a href='https://www.aladin.wrlc.org/Z-WEB/CLSReqForm?srcid=voyager:WRLC&bibid={{ holding.BIB_ID }}' target='clswindow'>Request</a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>
                        {% endif %}
                    </td>
                </tr>
          {%endif%}
        {% endfor %}
    {% endfor %}
    {%if bib.BIB_FORMAT == 'as'%}
         <tr>
             <td class='library-group-header'>
              InterLibrary Loan
             </td>
          </tr>
          <tr>
               <td>
                    <div class="itemrow">
                     Not available anywhere?
                    </div>
               </td>
               <td>                   </td>
               <td> 
                {%if bib.openurl.query_string%}  
<a href= {{bib.ILLIAD_LINK|add:bib.openurl.query_string|escape }} target='newwin'> Request a copy from another library </a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/>    
                {%else%}
<a href= {{bib.ILLIAD_LINK }} target='newwin'> Request a copy from another library </a><img src='{{ STATIC_URL }}img/external-link.jpg' width='16' height='10'/> 
               {%endif%}
                </td>
               <td> </td>
           </tr>
       {%endif%}
    </tbody>
</table> 
{% endif %}

{% if debug %}
<h3>Debugging info</h3>

<p>
{% if bibid %}
View JSON: <a href='{% url "item_json" bibid %}?{{ bib.openurl.query_string|escape }}'>{% url "item_json" bibid %}</a>
&nbsp;
{% endif %}

{% if bib.ISBN|clean_isbn %}
ISBN: <a href='{% url "isbn" bib.ISBN|clean_isbn %}'>{% url "isbn" bib.ISBN|clean_isbn %}</a>
&nbsp;
    {% if link_resolver.base_url and link_resolver.name %}
    (<a href='{{ link_resolver.base_url }}?isbn={{ bib.ISBN|clean_isbn }}&amp;{{ bib.openurl.query_string|escape }}'>{{ link_resolver.name }}</a>)
&nbsp;
    {% endif %}
{% endif %}
{% if bib.ISSN|clean_issn %}
ISSN: <a href='{% url "issn" bib.ISSN|clean_issn %}?{{ bib.openurl.query_string|escape }}'>{% url "issn" bib.ISSN|clean_issn %}</a>
&nbsp;
    {% if link_resolver.base_url and link_resolver.name %}
    (<a href='{{ link_resolver.base_url }}?issn={{ bib.ISSN|clean_issn }}&amp;{{ bib.openurl.query_string|escape }}'>{{ link_resolver.name }}</a>)
&nbsp;
    {% endif %}
{% endif %}
{% if bib.NETWORK_NUMBER|clean_oclc %}
OCLC: <a href='{% url "oclc" bib.NETWORK_NUMBER|clean_oclc %}?{{ bib.openurl.query_string|escape }}'>{% url "oclc" bib.NETWORK_NUMBER|clean_oclc %}</a>
&nbsp;
{% endif %}
</p>


{% endif %}

{% endblock content %}
